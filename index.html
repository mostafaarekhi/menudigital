<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>گردونه شانس</title>
  <style>
    :root{
      --bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa6b2;--glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family:"Vazirmatn","Arial",sans-serif}
    body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071025 0%, #0f1724 100%);color:#e6eef6;display:flex;align-items:center;justify-content:center;padding:24px;}
    .wrap{width:100%;max-width:700px;background:var(--card);border-radius:12px;padding:24px;box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    h1{text-align:center;margin:0 0 20px;}
    form{background:var(--glass);padding:20px;border-radius:10px;}
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;margin-bottom:12px;font-size:15px}
    .btn{display:inline-block;padding:10px 16px;border-radius:10px;border:none;background:var(--accent);color:#042d33;font-weight:600;cursor:pointer}
    .error{color:#ffb4b4;background:rgba(255,80,80,0.06);padding:8px;border-radius:8px;margin-bottom:10px;display:none;text-align:center}
    /* ابتدا wheelArea مخفیه و کانواس داخلش ایجاد نمیشه تا رندر زودهنگام اتفاق نیافته */
    .wheel-area{display:none;text-align:center;flex-direction:column;align-items:center}
    canvas{width:100%;max-width:350px;border-radius:50%;background:transparent;margin-bottom:20px}
    .result{margin-top:10px;padding:10px;border-radius:8px;background:rgba(6,182,212,0.08);color:var(--accent);font-weight:700}
    .muted{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>گردونه شانس</h1>

    <!-- فرم ثبت -->
    <form id="entryForm" autocomplete="off">
      <div id="formError" class="error"></div>
      <label for="fname">نام</label>
      <input id="fname" type="text" placeholder="مثال: مصطفی" required />
      <label for="lname">فامیل</label>
      <input id="lname" type="text" placeholder="مثال: ارکھی" required />
      <label for="age">سن</label>
      <input id="age" type="number" placeholder="مثال: 30" required />
      <div style="text-align:center;margin-top:14px">
        <button class="btn" type="submit">ثبت اطلاعات</button>
      </div>
    </form>

    <!-- گردونه: کانواس و دکمه بعد از ثبت به طور دینامیک اضافه می‌شن -->
    <div class="wheel-area" id="wheelArea">
      <!-- کانواس به صورت داینامیک ایجاد می‌شود تا هیچ رندر زودهنگامی نداشته باشیم -->
      <div id="wheelContainer"></div>
      <button class="btn" id="spinBtn">بچرخان</button>
      <div id="resultBox" class="result" style="display:none"></div>
      <div id="alreadyMsg" class="muted" style="margin-top:10px;display:none"></div>
    </div>
  </div>

<script>
/* ---------- متغیرهای رابط ---------- */
const form = document.getElementById('entryForm');
const formError = document.getElementById('formError');
const wheelArea = document.getElementById('wheelArea');
const wheelContainer = document.getElementById('wheelContainer');
const spinBtn = document.getElementById('spinBtn');
const resultBox = document.getElementById('resultBox');
const alreadyMsg = document.getElementById('alreadyMsg');

/* ---------- تنظیمات بخش و توابع گردونه (آمادهٔ اجرا در زمان نمایش) ---------- */
let canvas, ctx, center, radius;
let segments = [
  {label:"۵۰% تخفیف",color:"#ffb86b"},
  {label:"کد تخفیف ۲۰%",color:"#8bd3c7"},
  {label:"ارسال رایگان",color:"#a7f3d0"},
  {label:"کارت هدیه",color:"#fde68a"},
  {label:"هیچ‌چی :(",color:"#9aa6b2"},
  {label:"بلیت قرعه‌کشی",color:"#c7b7ff"}
];
let spinning=false, currentRotation=0;

/* تابعی برای اولیه‌سازی کانواس و رسم اولیۀ گردونه */
function initWheelAndDrawOnce(){
  // اگر قبلاً ساخته شده، دوباره نساز
  if(canvas) return;
  // ایجاد کانواس و اضافه به کانتینر
  canvas = document.createElement('canvas');
  canvas.width = 800;
  canvas.height = 800;
  canvas.id = 'wheel';
  wheelContainer.appendChild(canvas);
  ctx = canvas.getContext('2d');
  center = {x: canvas.width/2, y: canvas.height/2};
  radius = Math.min(canvas.width, canvas.height)/2 - 10;
  drawWheel(0); // فقط پس از ساخت کانواس رسم می‌کنیم
}

/* رسم گردونه با زاویهٔ rot (رادیان) */
function drawWheel(rot=0){
  const segAngle = 2*Math.PI/segments.length;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(center.x, center.y);
  ctx.rotate(rot);
  for(let i=0;i<segments.length;i++){
    const start=i*segAngle;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius,start,start+segAngle);
    ctx.closePath();
    ctx.fillStyle=segments[i].color;
    ctx.fill();
    ctx.save();
    ctx.rotate(start+segAngle/2);
    ctx.textAlign="right";
    ctx.fillStyle="#042028";
    ctx.font="bold 26px Vazirmatn, Arial";
    ctx.fillText(segments[i].label, radius-15, 10);
    ctx.restore();
  }
  ctx.restore();
  // pointer
  ctx.fillStyle="#fff";
  ctx.beginPath();
  ctx.moveTo(center.x-10,10);
  ctx.lineTo(center.x+10,10);
  ctx.lineTo(center.x,40);
  ctx.closePath();
  ctx.fill();
}

/* انیمیشن چرخش و نشان دادن نتیجه */
function spinOnce(){
  if(spinning) return;
  spinning = true;
  spinBtn.disabled = true;
  resultBox.style.display = 'none';
  const segAngle = 360 / segments.length;
  const targetIndex = Math.floor(Math.random()*segments.length);
  const finalDeg = 360*4 + (360 - (targetIndex*segAngle + segAngle/2));
  const finalRad = finalDeg * Math.PI/180;
  const start = performance.now(), duration = 4000;
  (function anim(t){
    const p = Math.min((t-start)/duration,1);
    const ease = 1 - Math.pow(1-p,3);
    const angle = currentRotation + (finalRad - currentRotation) * ease;
    drawWheel(angle);
    if(p < 1) requestAnimationFrame(anim);
    else {
      currentRotation = finalRad;
      showResult(targetIndex);
      spinning = false;
    }
  })(start);
}

/* نمایش نتیجه و ذخیره در localStorage */
function showResult(index){
  resultBox.textContent = "نتیجه: " + segments[index].label;
  resultBox.style.display = 'block';
  const user = JSON.parse(localStorage.getItem('wheel_user') || 'null');
  if(user){
    user.spun = true;
    user.result = segments[index].label;
    user.time = new Date().toISOString();
    localStorage.setItem('wheel_user', JSON.stringify(user));
    alreadyMsg.textContent = `نتیجه ثبت شد: ${user.result}`;
    alreadyMsg.style.display = 'block';
  }
}

/* ---------- فرم: ارسال اطلاعات ---------- */
form.addEventListener('submit', e=>{
  e.preventDefault();
  formError.style.display = 'none';
  const fname = document.getElementById('fname').value.trim();
  const lname = document.getElementById('lname').value.trim();
  const age = document.getElementById('age').value.trim();
  if(!fname || !lname || !age){
    formError.textContent = "لطفاً همه فیلدها را پر کنید.";
    formError.style.display = 'block';
    return;
  }
  const ageNum = Number(age);
  if(Number.isNaN(ageNum) || ageNum < 1 || ageNum > 120){
    formError.textContent = "لطفاً سن معتبر وارد کنید.";
    formError.style.display = 'block';
    return;
  }

  const data = {fname, lname, age: ageNum, spun: false, created: new Date().toISOString()};
  localStorage.setItem('wheel_user', JSON.stringify(data));

  // مخفی کردن فرم و نمایش بخش گردونه — قبل از نمایش، کانواس را می‌سازیم و رسم می‌کنیم
  form.style.display = 'none';
  wheelArea.style.display = 'flex';
  initWheelAndDrawOnce();
  spinBtn.disabled = false;
});

/* ---------- بارگذاری اولیه: اگر کاربر قبلاً ثبت کرده باشد ---------- */
window.addEventListener('load', ()=>{
  const user = JSON.parse(localStorage.getItem('wheel_user') || 'null');
  if(user){
    // مخفی کردن فرم، نمایش گردونه، ساخت کانواس و نمایش نتیجه در صورت چرخش قبلی
    form.style.display = 'none';
    wheelArea.style.display = 'flex';
    initWheelAndDrawOnce();
    if(user.spun){
      alreadyMsg.textContent = `شما قبلاً گردونه را چرخانده‌اید. نتیجه: ${user.result}`;
      alreadyMsg.style.display = 'block';
      spinBtn.disabled = true;
      resultBox.textContent = `نتیجه: ${user.result}`;
      resultBox.style.display = 'block';
    } else {
      spinBtn.disabled = false;
    }
    // پر کردن فرم (اگر خواستی بعداً ویرایش کنه) -- مخفی هست اما مفیده
    document.getElementById('fname').value = user.fname || '';
    document.getElementById('lname').value = user.lname || '';
    document.getElementById('age').value = user.age || '';
  } else {
    // هیچ کاربری ثبت نشده؛ مطمئن می‌شویم wheelArea مخفی بمونه و کانواس ساخته نشه
    wheelArea.style.display = 'none';
    spinBtn.disabled = true;
  }
});

/* ---------- دکمهٔ چرخش ---------- */
spinBtn.addEventListener('click', ()=>{
  const user = JSON.parse(localStorage.getItem('wheel_user') || 'null');
  if(!user){
    alert("ابتدا فرم را ثبت کنید.");
    return;
  }
  if(user.spun){
    alert("شما قبلاً چرخانده‌اید.");
    return;
  }
  spinOnce();
});
</script>
</body>
</html>
